/*
Copyright (c) 2025 Diagrid Inc.
Licensed under the MIT License.
*/

syntax = "proto3";

package queue;

import "proto/stored/job.proto";
import "proto/api/trigger.proto";

option go_package = "github.com/diagridio/go-etcd-cron/internal/api/queue";

// ControlEvent is a queue event which should be executed in turn of the queue
// control loop. Used for all job events.
message ControlEvent {
  // action is the typed action which should be executed by the queue control
  // loop.
  oneof action {
    Informed informed = 1;
    ExecuteRequest execute_request = 2;
    ExecuteResponse execute_response = 3;
    DeliverablePrefixes deliverable_prefixes = 4;
    UndeliverablePrefixes undeliverable_prefixes = 5;
    CloseJob close_job = 6;
    Close close = 7;
  }
}

// JobEvent is queue events that should be processed by the inner Job event
// loop. These events are performed on a per-job handler.
message JobEvent {
  // action is the typed action which should be executed by the job event.
  JobAction action = 1;
}

message JobAction {
  // action is the typed action which should be executed by the queue control
  // loop.
  oneof action {
    Informed informed = 1;
    ExecuteRequest execute_request = 2;
    ExecuteResponse execute_response = 3;
    DeliverableJob deliverable = 4;
    CloseJob close_job = 5;
    Close close = 6;
  }
}

// QueuedJob is a job stored in the queue with its modification revision.
message QueuedJob {
  // mod_revision is the storage modification revision of the job.
  int64 mod_revision = 1;

  // stored is the stored job object.
  stored.Job stored = 2;
}

// Informed is the event that is sent to the queue when a job is added or
// deleted from the storage informer.
message Informed {
  // queued_job is the job object that was added or deleted.
  QueuedJob queued_job = 1;

  // name is the name of the job object.
  string name = 2;

  // is_put is true if the event is a put event, false if it is a delete event.
  bool is_put = 3;
}

// ExecuteRequest is the queue event to execute a job.
message ExecuteRequest {
  // mod_revision is the mod revision of the  key of the job counter to execute.
  int64 mod_revision = 1;
}

// ExecuteResponse is to report the result of a job execution.
message ExecuteResponse {
  // mod_revision is the mod revision of the key of the job counter to execute.
  // tracks the id of this execution to account for mid-execution
  // cancellations.
  int64 mod_revision = 1;

  // result is the trigger result of executing this job counter.
  api.TriggerResponse result = 3;
}

// DeliverablePrefixes is a queue event which instructs that the given prefixes
// can now be executed by the queue executor.
message DeliverablePrefixes {
  // prefixes is the set of prefixes that can now be executed.
  repeated string prefixes = 1;
}

// UndeliverablePrefixes is a queue event which instructs that the previously
// given prefixes can no longer be executed by the queue executor.
message UndeliverablePrefixes {
  // prefixes is the set of prefixes that can no longer be executed.
  repeated string prefixes = 1;
}

// Close is a queue event which instructs that the queue executor should close.
message Close {}

// CloseJob is a queue event which instructs the given job mod revision has
// been closed and the associated resources should be released.
message CloseJob {
  // mod_revision is the job whose resources should be closed.
  int64 mod_revision = 1;
}

// DeliverableJob is a job event which instructs that the given job can now be
// executed by the queue executor.
message DeliverableJob {
  // mod_revision is the job mod revision that can now be executed.
  int64 mod_revision = 1;
}
